<view class="container">
  <view class="header">
    <view class="mbti-info">
      <text class="mbti-label">MBTIç±»å‹ï¼š</text>
      <text class="mbti-value">{{mbtiType}}</text>
      <text class="retest-btn" bindtap="retakeTest">é‡æµ‹</text>
    </view>
    
    <!-- æ•°æ®ç»Ÿè®¡åŒºåŸŸ -->
    <view class="statistics-card">
      <view class="stat-item">
        <text class="stat-value">{{getCompletedDaysCount()}}</text>
        <text class="stat-label">å·²å®Œæˆå¤©æ•°</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{getCompletedTasksCount()}}</text>
        <text class="stat-label">å·²å®Œæˆä»»åŠ¡</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{getMediaUploadsCount('image')}}</text>
        <text class="stat-label">å›¾ç‰‡ä¸Šä¼ </text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{getMediaUploadsCount('audio')}}</text>
        <text class="stat-label">è¯­éŸ³è®°å½•</text>
      </view>
      <view class="stats-more" bindtap="viewDetailedStats">
        <text>è¯¦ç»†æ•°æ®</text>
        <text class="arrow">â†’</text>
      </view>
    </view>
  </view>
  
  <!-- æ—¥æœŸå¯¼èˆªä½¿ç”¨å·¦å³ç®­å¤´ -->
  <view class="days-nav-container">
    <view class="day-arrow {{expandedDay === 1 ? 'disabled' : ''}}" bindtap="navigatePrevDay">
      <text class="arrow-icon">â†</text>
    </view>
    
    <view class="days-nav">
      <view 
        wx:for="{{7}}" 
        wx:key="*this"
        class="day-item {{expandedDay === index + 1 ? 'active' : ''}} {{!isDayUnlocked(index + 1) ? 'locked' : ''}}"
        bindtap="handleDayTap"
        data-day="{{index + 1}}"
      >
        <text class="day-text">ç¬¬{{index + 1}}å¤©</text>
        <view class="day-indicator {{isDayCompleted(index + 1) ? 'completed' : ''}}"></view>
      </view>
    </view>
    
    <view class="day-arrow {{expandedDay === 7 ? 'disabled' : ''}}" bindtap="navigateNextDay">
      <text class="arrow-icon">â†’</text>
    </view>
  </view>

  <!-- è§£é”çŠ¶æ€æŒ‰é’® -->
  <view class="unlock-button" bindtap="toggleUnlockMode">
    <text>{{unlockModeStates[expandedDay] ? 'å·²è§£é”' : 'æœªè§£é”'}}</text>
  </view>
  
  <!-- æ»‘åŠ¨å®¹å™¨ - ç»‘å®šè§¦æ‘¸äº‹ä»¶ -->
  <view 
    class="tasks-container" 
    bindtouchstart="handleTouchStart"
    bindtouchend="handleTouchEnd"
  >
    <!-- æ°´å¹³æ»‘åŠ¨è§†å›¾ -->
    <view class="days-slider">
      <!-- å½“å‰æ—¥æ˜¾ç¤º -->
      <view class="day-content">
        <view class="day-header">
          <text class="day-title">ç¬¬{{expandedDay}}å¤©ä»»åŠ¡</text>
          <text class="day-status {{!isDayUnlocked(expandedDay) ? 'locked-status' : ''}}">
            {{getDayStatusText(expandedDay)}}
          </text>
        </view>
        
        <view class="task-list">
          <view 
            wx:for="{{dayTasks}}" 
            wx:key="title"
            class="task-item {{!isDayUnlocked(expandedDay) && !unlockModeStates[expandedDay] ? 'locked' : ''}} {{isTaskCompleted(expandedDay, item.title) ? 'completed' : ''}}"
            bindtap="handleTaskTap" data-day="{{expandedDay}}" data-index="{{index}}"
          >
            <view class="task-content">
              <view class="task-header">
                <view class="task-title">{{item.title}}</view>
                <view class="task-category">{{item.type}} Â· {{item.difficulty}}</view>
              </view>
              <view class="task-reason">ä¸ºä»€ä¹ˆï¼š{{item.reason}}</view>
              <view class="task-locked-status" wx:if="{{!isDayUnlocked(expandedDay) && !unlockModeStates[expandedDay]}}">
                <text>å®Œæˆå‰ä¸€å¤©æ‰€æœ‰ä»»åŠ¡å¯è§£é”</text>
              </view>
              
              <!-- è§£é”æ¨¡å¼ä¸‹æ˜¾ç¤ºå½“å¤©çš„å†…å®¹ -->
              <block wx:if="{{unlockModeStates[expandedDay] && !isDayUnlocked(expandedDay) && expandedDay !== 1}}">
                <!-- æ˜¾ç¤ºå½“å¤©çš„å†å²è®°å½• -->
                <history-container 
                  wx:if="{{textInputHistory.length > 0 || imageInputHistory.length > 0 || audioInputHistory.length > 0}}"
                  title="æ‰“å¡å†å²è®°å½•"
                  mixedRecords="{{combinedHistory}}"
                  currentPlayingAudio="{{currentPlayingAudio}}"
                  bind:imagePreview="previewImage"
                  bind:audioPlay="playAudio"
                />
              </block>
              
              <!-- ä¸ºç¬¬ä¸€å¤©çš„ä»»åŠ¡æ·»åŠ å†å²è®°å½•å®¹å™¨ç»„ä»¶ -->
              <block wx:if="{{expandedDay === 1}}">
                <!-- ä»»åŠ¡1ï¼ˆä½¿ç”¨åŸæœ‰è®°å½•ï¼‰ -->
                <block wx:if="{{index === 0}}">
                  <history-container 
                    wx:if="{{textInputHistory.length > 0 || imageInputHistory.length > 0 || audioInputHistory.length > 0}}"
                    title="æ‰“å¡å†å²è®°å½•"
                    mixedRecords="{{combinedHistory}}"
                    currentPlayingAudio="{{currentPlayingAudio}}"
                    bind:imagePreview="previewImage"
                    bind:audioPlay="playAudio"
                  />
                </block>
                
                <!-- ä»»åŠ¡2ï¼ˆæ˜¾ç¤ºä»»åŠ¡2çš„å†å²è®°å½•ï¼‰ -->
                <block wx:if="{{index === 1}}">
                  <history-container 
                    title="æ‰“å¡å†å²è®°å½•"
                    mixedRecords="{{task2History}}"
                    currentPlayingAudio="{{currentPlayingAudio}}"
                    bind:imagePreview="previewImage"
                    bind:audioPlay="playAudio"
                    emptyText="æš‚æ— æ‰“å¡è®°å½•"
                  />
                </block>
                
                <!-- ä»»åŠ¡3ï¼ˆæ˜¾ç¤ºä»»åŠ¡3çš„å†å²è®°å½•ï¼‰ -->
                <block wx:if="{{index === 2}}">
                  <history-container 
                    title="æ‰“å¡å†å²è®°å½•"
                    mixedRecords="{{task3History}}"
                    currentPlayingAudio="{{currentPlayingAudio}}"
                    bind:imagePreview="previewImage"
                    bind:audioPlay="playAudio"
                    emptyText="æš‚æ— æ‰“å¡è®°å½•"
                  />
                </block>
              </block>
              
              <!-- å¿«é€Ÿæ‰“å¡æŒ‰é’®åŒºåŸŸ -->
              <view class="quick-checkin-buttons" wx:if="{{(isDayUnlocked(expandedDay) || expandedDay === 1 || unlockModeStates[expandedDay]) && !isTaskCompleted(expandedDay, index)}}">
                <view class="checkin-grid">
                  <view class="checkin-btn tomato-btn" bindtap="startTomatoTimer" data-task="{{item}}">
                    <text class="btn-label">ç•ªèŒ„æ‰“å¡</text>
                  </view>
                  <view class="checkin-btn text-btn" bindtap="openTextCheckin" data-task="{{item}}">
                    <text class="btn-label">æ–‡å­—æ‰“å¡</text>
                  </view>
                  <view class="checkin-btn image-btn" bindtap="openImageCheckin" data-task="{{item}}">
                    <text class="btn-label">å›¾ç‰‡æ‰“å¡</text>
                  </view>
                  <view class="checkin-btn audio-btn {{isRecording ? 'recording' : ''}}" bindtap="openAudioCheckin" data-task="{{item}}">
                    <text class="btn-label">è¯­éŸ³æ‰“å¡</text>
                  </view>
                </view>
              </view>
              
              <!-- ç•ªèŒ„è®¡æ—¶å™¨é®ç½©å±‚ -->
              <view class="tomato-overlay {{showTomatoTimer ? 'visible' : ''}}" bindtap="toggleTomatoTimer">
                <view class="tomato-circle {{!isTomatoRunning && isTomatoStarted && tomatoTimeLeft === 5 ? 'completed' : ''}}">
                  <text class="tomato-countdown" wx:if="{{!(isTomatoStarted && !isTomatoRunning && tomatoTimeLeft === 5)}}">{{tomatoTimeLeft}}</text>
                  <text class="tomato-text">
                    {{!isTomatoStarted ? 'å¼€å§‹' : 
                      isTomatoRunning ? 'ä¸“æ³¨ä¸­' : 
                      tomatoTimeLeft === 5 ? 'æ­å–œå®Œæˆ' : 'æš‚åœ'}}
                  </text>
                </view>
              </view>
              
              <!-- æ‰“å¡è®°å½•åˆ—è¡¨ -->
              <view class="records-list" wx:if="{{item.records && item.records.length > 0 && (isDayUnlocked(expandedDay) || unlockModeStates[expandedDay])}}">
                <view 
                  wx:for="{{item.records}}" 
                  wx:for-item="record"
                  wx:key="timestamp"
                  class="record-item record-{{record.method}}"
                >
                  <view class="record-time">{{record.timeFormatted}}</view>
                  <view class="record-content">
                    <text wx:if="{{record.method === 'text'}}" class="record-text">{{record.content}}</text>
                    <image wx:elif="{{record.method === 'image'}}" class="record-image" src="{{record.content}}" mode="aspectFill"></image>
                    <view wx:elif="{{record.method === 'audio'}}" class="record-audio" bindtap="playAudio" data-audio-src="{{record.content}}">
                      <text class="audio-icon">ğŸ”Š</text>
                      <text class="audio-text">æ’­æ”¾</text>
                    </view>
                  </view>
                </view>
              </view>
            </view>
            
            <!-- å·²å®Œæˆæ ‡ç­¾ -->
            <view class="completion-status">
              <view class="completed-tag" wx:if="{{isTaskCompleted(expandedDay, item.title) || unlockModeStates[expandedDay]}}">
                <text>å·²å®Œæˆ</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
  
  <!-- æŸ¥çœ‹æ€»æŠ¥å‘ŠæŒ‰é’® -->
  <view class="report-button-area" wx:if="{{expandedDay === 7 || currentDay === 7}}">
    <button class="view-report-btn" bindtap="viewTotalReport">æŸ¥çœ‹æ€»æŠ¥å‘Š</button>
    <button class="next-week-btn" bindtap="startNextWeek" wx:if="{{currentDay >= 7}}">ä¸‹ä¸€ä¸ªä¸ƒå¤©ï¼Œæˆ‘éœ€è¦å¹²ä»€ä¹ˆï¼Ÿ</button>
  </view>
  
  <!-- æ‰“å¡æ¨¡æ€æ¡† -->
  <view class="checkin-modal {{isCheckinModalVisible ? 'visible' : ''}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">{{activeCheckinMethod === 'text' ? 'æ–‡å­—æ‰“å¡' : activeCheckinMethod === 'image' ? 'å›¾ç‰‡æ‰“å¡' : 'è¯­éŸ³æ‰“å¡'}}</text>
        <view class="close-btn" bindtap="closeCheckinModal">Ã—</view>
      </view>
      
      <view class="modal-body">
        <view class="task-info">
          <text class="task-name">{{activeTask.title}}</text>
        </view>
        
        <!-- æ–‡å­—æ‰“å¡ -->
        <view class="checkin-form" wx:if="{{activeCheckinMethod === 'text'}}">
          <textarea 
            class="text-input" 
            placeholder="åˆ†äº«ä½ çš„å®Œæˆæ„Ÿå—..." 
            bindinput="inputCheckinText"
            value="{{checkinContent}}"
          ></textarea>
        </view>
        
        <!-- å›¾ç‰‡æ‰“å¡ -->
        <view class="checkin-form" wx:if="{{activeCheckinMethod === 'image'}}">
          <view class="image-upload" bindtap="chooseImage">
            <image wx:if="{{checkinContent}}" src="{{checkinContent}}" mode="aspectFill" class="preview-image"></image>
            <view wx:else class="upload-btn">
              <text class="upload-icon">+</text>
              <text class="upload-text">ä¸Šä¼ å›¾ç‰‡</text>
            </view>
          </view>
        </view>
        
        <!-- å½•éŸ³æ‰“å¡ -->
        <view class="checkin-form" wx:if="{{activeCheckinMethod === 'audio'}}">
          <view class="audio-record">
            <view wx:if="{{!checkinContent}}" class="record-btn {{isRecording ? 'recording' : ''}}" bindtouchstart="startRecording" bindtouchend="stopRecording">
              <text class="record-icon">ğŸ¤</text>
              <text class="record-text">{{isRecording ? 'æ¾å¼€ç»“æŸ' : 'æŒ‰ä½å½•éŸ³'}}</text>
            </view>
            <view wx:else class="record-preview">
              <text class="preview-text">å½•éŸ³å·²å®Œæˆ</text>
              <view class="rerecord-btn" bindtap="startRecording">é‡æ–°å½•åˆ¶</view>
            </view>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="submit-btn" bindtap="submitCheckin">å®Œæˆæ‰“å¡</button>
      </view>
    </view>
  </view>
</view> 